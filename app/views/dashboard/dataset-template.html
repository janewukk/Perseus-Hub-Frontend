{% extends 'dashboard/base.html' %}

{% block tabstyles %}
<link rel="stylesheet" href="http://cdn.pydata.org/bokeh/release/bokeh-0.12.5.min.css">
<style type="text/css">
#priority-selector a {
	display: inline;
}
</style>
{% endblock %}

{% block tabs %}
<li class="active">
	<a data-toggle="collapse" href="#dataset-sections" 
		aria-expanded="false" 
		aria-controls="dataset-sections">
		<i class="fa fa-database" aria-hidden="true"></i> Datasets
	</a>
	<ul class="collapse nav" id="dataset-sections">
		<li><a href="/dashboard/">Public datasets</a></li>
		<li><a href="/dashboard/?my">My Datasets</a></li>
	</ul>
</li>
<li>
	<a data-toggle="collapse" href="#bookmark-sections" 
		aria-expanded="false" 
		aria-controls="bookmark-sections">
		<i class="fa fa-bookmark" aria-hidden="true"></i> Bookmarks
	</a>
	<ul class="collapse nav" id="bookmark-sections">
		<li><a href="/bookmarks/">Public bookmarks</a></li>
		<li><a href="/bookmarks/?my">My bookmarks</a></li>
	</ul>
</li>
<li>
	<a href="/upload/">
		<i class="fa fa-upload" aria-hidden="true"></i> Upload data file
	</a>
</li>
{% endblock %}

{% block tabdetails %}
<div class="row">
	<div class="col-sm-10">
		<div class="row" style="margin-top: 20px">
			<div class="col-sm-10">
				<ul class="nav nav-tabs" role="tablist">
					<li role="presentation" class="active"><a href="#info-console" aria-controls="info-console" role="tab" data-toggle="tab">Information console</a></li>
					<li role="presentation"><a href="#egonet" aria-controls="egonet" role="tab" data-toggle="tab">EgoNet</a></li>
					<li role="presentation"><a href="#adj-maxtrix" aria-controls="adj-maxtrix" role="tab" data-toggle="tab">Adj Matrix</a></li>
					<li style="float:right">
						<span class="star" data-toggle="tooltip" data-placement="right" title="Click to bookmark/unbookmark">
							<span class="star-icon fa fa-star" ></span>
						</span>
					</li>
				</ul>
				<div class="tab-content">
					<div role="tabpanel" class="tab-pane active" id="info-console">
						<table class="table table-hover">
						  <thead>
						  	<tr>
						  		<th>Node ID</th>
						  		<th>Number</th>
						  		<th>Degree</th>
						  		<th>Degree(U)</th>
						  		<th>PageRank</th>
						  		<th>Eigenvector</th>
						  		<th>Egonet</th>
						  		<th>Adj matrix</th>
						  	</tr>
						  </thead>
						  <tbody>
						  	<tr>
						  		<td>466</td>
						  		<td>1-85e</td>
						  		<td>65</td>
						  		<td>10</td>
						  		<td>2.6e-05</td>
						  		<td>2.2009e-7</td>
						  		<td><button class="btn btn-primary btn-sm">View</button></td>
						  		<td><button class="btn btn-primary btn-sm">View</button></td>
						  	</tr>
						  </tbody>
						</table>
					</div>
					<div role="tabpanel" class="tab-pane" id="egonet">...</div>
					<div role="tabpanel" class="tab-pane" id="adj-maxtrix">...</div>
				</div>
			</div>
		</div>


		<!--Display the Bokeh plots-->
		{{ graph | safe }}

		<!--Table with egonet and adjacency matrix D3 Graphs-->
		<table class="table">
			<tbody>
				<tr>
					<td><svg class="adjacency" style="width:500px;height:500px; lightgray solid;"/></td>
					<td><svg class="egonet"/></td>
				</tr>
			</tbody>
		</table>


		<style>
			.node circle {
				fill: steelblue;
			}

			.link {
				fill: none;
				stroke: #000;
				stroke-opacity: .2;
			}
		</style>

    	<script src="http://d3js.org/d3.v3.min.js"></script>

		<!--Script for the egonet D3 plot-->
		<script>
			console.log("Enters Egonet");
			var width = 500,
				height = 500

			var svg = d3.select(".egonet")
				.attr("width", width)
				.attr("height", height);

			var force = d3.layout.force()
				.gravity(.05)
				.distance(100)
				.charge(-100)
				.size([width, height]);

			d3.json("{% url "egonet" %}", function(error, json) {
			var edges = [];
				json.Links.forEach(function(e) { 
				var sourceNode = json.Nodes.filter(function(n) { return n.Id === e.Source; })[0],
				targetNode = json.Nodes.filter(function(n) { return n.Id === e.Target; })[0];
					
				edges.push({source: sourceNode, target: targetNode, value: e.Value});
				});
				
			force
				.nodes(json.Nodes)
				.links(edges)
				.start();

			var link = svg.selectAll(".link")
				.data(edges)
				.enter().append("line")
				.attr("class", "link");

			var node = svg.selectAll(".node")
				.data(json.Nodes)
				.enter().append("g")
				.attr("class", "node")
				.call(force.drag);

			node.append("circle")
				.attr("class", "node")
				.attr("r", 5);

			node.append("svg:a")
				.attr("xlink:href", function(d){return d.Url;})
				.append("text")
				.attr("dx", 12)
				.attr("dy", ".35em")
				.text(function(d) { return d.Name})

			
			force.on("tick", function() {
				link.attr("x1", function(d) { return d.source.x; })
					.attr("y1", function(d) { return d.source.y; })
					.attr("x2", function(d) { return d.target.x; })
					.attr("y2", function(d) { return d.target.y; });

				node.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });
			});
			});
		</script>

	
		<style>
			.tick line {
				shape-rendering: crispEdges;
				stroke: #000;
			}

			line.minor  {
				stroke: #777;
				stroke-dasharray: 2,2;
			}

			path.domain {
				fill: none;
				stroke: black;
			}
		</style>

		<!--Script for the D3 adjacency matrix plot-->
		<script>
			console.log("enters adj")
			createAdjacencyMatrix()
		
			function createAdjacencyMatrix() {
				var edgeHash = {};
				weight = [3, 8, 2, 1, 5, 1, 1, 5, 3, 1, 3, 2, 1, 7, 1, 4, 1, 3, 1, 2, 5]
				source = ["sam", "sam", "sam", "sam", "roy", "roy", "tully", "tully", "tully", "tully", "tully", "kim", "kim", "mo", "mo", "mo", "mo", "pat","pat","pat","pat"]
				target = ["tully", "pat", "kim", "pris", "pris","sam", "pris", "kim", "pat", "mo", "pat", "mo", "tully", "pat", "sam", "pris", "sam", "tully", "kim", "mo"]
				nodes = ["sam", "roy", "tully", "kim", "pat", "pris", "mo"]
				var edgeHash = {};
				for (var i = 0; i < source.length; i++) {
					var id = source[i] + "-" + target[i];
					edgeHash[id] = weight[i];
				}

				matrix = [];
				for (a in nodes) {
					for (b in nodes) {
						var grid = {id: nodes[a] + "-" + nodes[b], x: b, y: a, weight: 0};
						if (edgeHash[grid.id]) {
							grid.weight = 1;
						}
						matrix.push(grid);
					}
				}
				console.log("finish updating matrix")

				d3.select(".adjacency")
				.append("g")
				.attr("transform", "translate(50,50)")
				.attr("id", "adjacencyG")
				.selectAll("rect")
				.data(matrix)
				.enter()
				.append("rect")
				.attr("width", 25)
				.attr("height", 25)
				.attr("x", function (d) {return d.x * 25})
				.attr("y", function (d) {return d.y * 25})
				.style("stroke", "black")
				.style("stroke-width", "1px")
				.style("fill", "red")
				.style("fill-opacity", function (d) {return d.weight * .2})
				.on("mouseover", gridOver)
		
				var scaleSize = nodes.length * 25;
				var nameScale = d3.scale.ordinal()
					.rangePoints([0, scaleSize], 1)
					.domain(nodes)

				console.log("nameScale")
				console.log(nameScale)
		
				xAxis = d3.svg.axis()
					.scale(nameScale)
					.tickSize(4)
					.orient("top");    
				yAxis = d3.svg.axis()
					.scale(nameScale)
					.tickSize(4)
					.orient("left");    
				d3.select("#adjacencyG").append("g").call(xAxis).selectAll("text").style("text-anchor", "end").attr("transform", "translate(-10,-10) rotate(90)");
				d3.select("#adjacencyG").append("g").call(yAxis);
		
				function gridOver(d,i) {
					d3.selectAll("rect").style("stroke-width", function (p) {return p.x == d.x || p.y == d.y ? "3px" : "1px"})
				}
			}
		</script>
	</div>
</div>
<!-- Bookmark creator -->
<div class="modal fade" id="bookmark-creator" tabindex="-1" role="dialog" aria-labelledby="bookmark-creator">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
				<h4 class="modal-title" id="bookmark-creator">Bookmark the selection</h4>
			</div>
			<div class="modal-body">
				<div>
					<div class="form-group">
						<label for="priority">Please select a priority</label>
						<div class="dropdown">
							<button class="btn btn-default dropdown-toggle" type="button" id="priority-selector" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
								<span data-bind="text: priority"></span>
								<span class="caret"></span>
							</button>
							<ul class="dropdown-menu" id="priority-selector" aria-labelledby="priority-selector">
								<li style="padding: 10px">
									<span style="background-color: red; width: 20px; height: 20px; float: left"></span>
									<a data-bind="click: selectPriority('high', 2)">High</a>
								</li>
								<li style="padding: 10px">
									<span style="background-color: yellow; width: 20px; height: 20px; float: left"></span>
									<a data-bind="click: selectPriority('medium', 1)">Medium</a>
								</li>
								<li style="padding: 10px">
									<span style="background-color: green; width: 20px; height: 20px; float: left"></span>
									<a data-bind="click: selectPriority('low', 0)">Low</a>
								</li>
							</ul>
						</div>
					</div>
					<div class="checkbox">
						<label>
						<input type="checkbox" data-bind="checked: publicized"> Do you want to publicize it?
						</label>
					</div>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
				<button type="button" class="btn btn-primary">Create</button>
			</div>
		</div>
	</div>
</div>
<!-- Bookmark remover -->
<div class="modal fade" id="bookmark-remover" tabindex="-1" role="dialog" aria-labelledby="bookmark-remover">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
				<h4 class="modal-title" id="bookmark-creator">Bookmark removal</h4>
			</div>
			<div class="modal-body">
				<div>
					Are you sure you want to remove this bookmark ?
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
				<button type="button" class="btn btn-danger">Remove</button>
			</div>
		</div>
	</div>
</div>
{% endblock %}

{% block scripts %}
<!-- @removed: Vega js -->
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/vega/3.0.0-beta.28/vega.js"></script> -->
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/vega-lite/2.0.0-alpha.7/vega-lite.js"></script> -->
<!-- Bokeh JS -->
<script src="http://cdn.pydata.org/bokeh/release/bokeh-0.12.5.min.js"></script>
<script src="http://cdn.pydata.org/bokeh/release/bokeh-widgets-0.12.5.min.js"></script>
<!-- Graph JS -->
{{ graph_script | safe }}
<script type="text/javascript">
	// star animation
	var star = $(".star");
	star.on('star:toggled', function(event) {
		var on = event['on'];
		if (!on) {
			// turn off star
			star.removeClass("starred");
			star.addClass("unstarred");
		} else {
			// turn on star
			star.removeClass("unstarred");
			star.addClass("starred");
		}
	});

	// init view models
	var bookmarkView = new View({
		el : document.getElementById('bookmark-creator'),
		data : {
			priority : 'medium',
			priorityVal : 0,
			publicized : false,
			metadata : {
				nodeId : 'xxxx'
			}
		},
		methods : {
			selectPriority : function (val, level) {
				this.priority(val);
				this.priorityVal(level);
			}
		}
	});

	// check bookmarked status
	var bookmarked = {{ bookmarked }};

	if (bookmarked) {
		// highlight star
		trigger($('.star'), 'star:toggled', {
			on : true
		})
		// click to show bookmark remover
		$('.star').click(function() {
			$('#bookmark-remover').modal();
		});

	} else {
		// click to show bookmark creator
		$('.star').click(function() {
			$('#bookmark-creator').modal();
		});
	}

	// graph callback function
	function nodeSelected(indices) {
		console.log("From FrontEnd ", indices);
		// var data = { "hahah": "hohohohoh" };
		// var args = { type:"POST", url:"/querry/", data:data };
		// $.ajax(args);

		$.ajax({
			type: 'POST',
			url: '/querry/',
			contentType: "application/json; charset=UTF-8",
			response: "application/json; charset=UTF-8",
			data: JSON.stringify({
				"indices": indices
			}),
			success: function (data) {
				console.log(data)
			}
      	});
		console.log("AJAX SENT!");
	}
</script>
{% endblock scripts %}